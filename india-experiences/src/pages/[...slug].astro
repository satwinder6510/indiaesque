---
import { getCollection, render } from 'astro:content';
import CityHub from '../layouts/CityHub.astro';
import CategoryPage from '../layouts/CategoryPage.astro';
import PAAPage from '../layouts/PAAPage.astro';
import BaseLayout from '../layouts/BaseLayout.astro';
import cities from '../data/cities.json';
import experiencesData from '../data/experiences.json';
import { searchProducts, getDestinationId } from '../lib/viator';

export const prerender = true;

// Map content categories to Viator tag IDs
const CATEGORY_TO_VIATOR_TAG: Record<string, number> = {};
experiencesData.forEach(exp => {
  // Map both slug and category field to tag ID
  CATEGORY_TO_VIATOR_TAG[exp.slug] = exp.viatorTagId;
  if (exp.category) {
    CATEGORY_TO_VIATOR_TAG[exp.category.toLowerCase()] = exp.viatorTagId;
  }
});

// Map PAA categories to relevant Viator tags for contextual tours
const PAA_CATEGORY_TOURS: Record<string, number[]> = {
  'food': [21911],           // Food & Drink
  'transport': [12044],      // Transfers
  'practical': [12044],      // Transfers (airport, getting around)
  'heritage': [12029, 13030], // Historical + Walking
  'activities': [21725],     // Sightseeing
  'shopping': [12039],       // Shopping
  'culture': [12028],        // Cultural
  'wellness': [21522],       // Yoga & Meditation
};

export async function getStaticPaths() {
  const allPages = await getCollection('pages');

  return allPages.map(entry => {
    let slug = entry.id;
    if (slug.endsWith('/_index')) {
      slug = slug.replace('/_index', '');
    }

    return {
      params: { slug },
      props: { entry },
    };
  });
}

const { entry } = Astro.props;
const { Content } = await render(entry);
const {
  title,
  description,
  city,
  type,
  faq,
  relatedPages,
  schema: schemaTypes,
  heroImage,
  datePublished,
  dateModified,
} = entry.data;

const cityData = cities.find(c => c.slug === city);
const cityName = cityData?.name ?? city ?? '';
const citySlug = city ?? '';

// Get best months from city data if available
const bestMonths = cityData?.bestMonths ?? [];
const goodMonths = cityData?.goodMonths ?? [];
const cityHeroImage = heroImage ?? cityData?.heroImage;

const siteUrl = 'https://indiaesque.com';
const pageUrl = `${siteUrl}/${Astro.params.slug}/`;
const schemaObjects: object[] = [];

schemaObjects.push({
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: title,
  description,
  author: { '@type': 'Organization', name: 'Indiaesque', url: siteUrl },
  publisher: { '@type': 'Organization', name: 'Indiaesque', logo: { '@type': 'ImageObject', url: `${siteUrl}/logo.png` } },
  datePublished: entry.data.datePublished,
  dateModified: entry.data.dateModified,
  mainEntityOfPage: { '@type': 'WebPage', '@id': pageUrl },
});

const breadcrumbItems: object[] = [
  { '@type': 'ListItem', position: 1, name: 'Home', item: siteUrl },
];
if (city) {
  breadcrumbItems.push({ '@type': 'ListItem', position: 2, name: cityName, item: `${siteUrl}/${citySlug}/` });
  if (type !== 'hub') {
    breadcrumbItems.push({ '@type': 'ListItem', position: 3, name: title, item: pageUrl });
  }
}
schemaObjects.push({
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: breadcrumbItems,
});

if (faq && faq.length > 0) {
  schemaObjects.push({
    '@context': 'https://schema.org',
    '@type': 'FAQPage',
    mainEntity: faq.map(f => ({
      '@type': 'Question',
      name: f.question,
      acceptedAnswer: { '@type': 'Answer', text: f.answer },
    })),
  });
}

if (type === 'hub' && cityData) {
  schemaObjects.push({
    '@context': 'https://schema.org',
    '@type': 'TouristDestination',
    name: cityName,
    description: cityData.description,
    geo: { '@type': 'GeoCoordinates', latitude: cityData.lat, longitude: cityData.lng },
    containedInPlace: { '@type': 'Country', name: 'India' },
  });
}

const relatedLinks = (relatedPages ?? []).map(href => {
  const parts = href.replace(/^\/|\/$/g, '').split('/');
  const last = parts[parts.length - 1];
  const label = last.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
  return { href, label };
});

const categoryName = entry.data.category !== 'general'
  ? entry.data.category.split('-').map((w: string) => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')
  : title;

// Fetch Viator products for category pages and relevant PAA pages
let viatorProducts: any[] = [];
const destId = citySlug ? getDestinationId(citySlug) : undefined;

if (destId) {
  if (type === 'category') {
    // For category pages, get the tag ID from the category slug or experiences data
    const categorySlugFromPath = entry.id.split('/').pop()?.replace('.md', '') || '';
    const tagId = CATEGORY_TO_VIATOR_TAG[categorySlugFromPath] || CATEGORY_TO_VIATOR_TAG[entry.data.category?.toLowerCase()];

    if (tagId) {
      viatorProducts = await searchProducts({ destId, tagIds: [tagId], limit: 6 });
    } else {
      // Fallback: fetch general tours for this destination
      viatorProducts = await searchProducts({ destId, limit: 6 });
    }
  } else if (type === 'paa' && entry.data.category) {
    // For PAA pages, check if the category has relevant tour types
    const paaCategory = entry.data.category.toLowerCase();
    const relevantTags = PAA_CATEGORY_TOURS[paaCategory];

    if (relevantTags && relevantTags.length > 0) {
      viatorProducts = await searchProducts({ destId, tagIds: relevantTags, limit: 4 });
    }
  }
}

// Transform Viator products for layouts
const experiences = viatorProducts.map(p => ({
  title: p.title,
  href: p.bookingLink,
  image: p.imageUrl,
  duration: p.duration,
  price: `From â‚¹${Math.round(p.price.amount).toLocaleString()}`,
  rating: p.rating,
  reviewCount: p.reviewCount,
}));
---

{type === 'hub' ? (
  <CityHub
    title={title}
    description={description}
    city={cityName}
    citySlug={citySlug}
    heroImage={cityHeroImage}
    bestMonths={bestMonths}
    goodMonths={goodMonths}
    faq={faq}
    relatedPages={relatedLinks}
    schema={schemaObjects}
  >
    <Content />
  </CityHub>
) : type === 'category' ? (
  <CategoryPage
    title={title}
    description={description}
    city={cityName}
    citySlug={citySlug}
    categoryName={categoryName}
    categorySlug={entry.data.category}
    heroImage={heroImage}
    faq={faq}
    relatedPages={relatedLinks}
    schema={schemaObjects}
    experiences={experiences}
  >
    <Content />
  </CategoryPage>
) : type === 'paa' ? (
  <PAAPage
    title={title}
    description={description}
    city={cityName}
    citySlug={citySlug}
    heroImage={cityHeroImage}
    datePublished={datePublished}
    dateModified={dateModified}
    faq={faq}
    relatedPages={relatedLinks}
    schema={schemaObjects}
    experiences={experiences}
  >
    <Content />
  </PAAPage>
) : (
  <BaseLayout title={title} description={description} schema={schemaObjects}>
    <Content />
  </BaseLayout>
)}
