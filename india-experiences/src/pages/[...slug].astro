---
import { getCollection, render } from 'astro:content';
import CityHub from '../layouts/CityHub.astro';
import CategoryPage from '../layouts/CategoryPage.astro';
import PAAPage from '../layouts/PAAPage.astro';
import BaseLayout from '../layouts/BaseLayout.astro';
import cities from '../data/cities.json';

export async function getStaticPaths() {
  const allPages = await getCollection('pages');

  return allPages.map(entry => {
    let slug = entry.id;
    if (slug.endsWith('/_index')) {
      slug = slug.replace('/_index', '');
    }

    return {
      params: { slug },
      props: { entry },
    };
  });
}

const { entry } = Astro.props;
const { Content } = await render(entry);
const {
  title,
  description,
  city,
  type,
  faq,
  relatedPages,
  schema: schemaTypes,
  heroImage,
  datePublished,
  dateModified,
} = entry.data;

const cityData = cities.find(c => c.slug === city);
const cityName = cityData?.name ?? city ?? '';
const citySlug = city ?? '';

// Get best months from city data if available
const bestMonths = cityData?.bestMonths ?? [];
const goodMonths = cityData?.goodMonths ?? [];
const cityHeroImage = heroImage ?? cityData?.heroImage;

const siteUrl = 'https://indiaesque.com';
const pageUrl = `${siteUrl}/${Astro.params.slug}/`;
const schemaObjects: object[] = [];

schemaObjects.push({
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: title,
  description,
  author: { '@type': 'Organization', name: 'Indiaesque', url: siteUrl },
  publisher: { '@type': 'Organization', name: 'Indiaesque', logo: { '@type': 'ImageObject', url: `${siteUrl}/logo.png` } },
  datePublished: entry.data.datePublished,
  dateModified: entry.data.dateModified,
  mainEntityOfPage: { '@type': 'WebPage', '@id': pageUrl },
});

const breadcrumbItems: object[] = [
  { '@type': 'ListItem', position: 1, name: 'Home', item: siteUrl },
];
if (city) {
  breadcrumbItems.push({ '@type': 'ListItem', position: 2, name: cityName, item: `${siteUrl}/${citySlug}/` });
  if (type !== 'hub') {
    breadcrumbItems.push({ '@type': 'ListItem', position: 3, name: title, item: pageUrl });
  }
}
schemaObjects.push({
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: breadcrumbItems,
});

if (faq && faq.length > 0) {
  schemaObjects.push({
    '@context': 'https://schema.org',
    '@type': 'FAQPage',
    mainEntity: faq.map(f => ({
      '@type': 'Question',
      name: f.question,
      acceptedAnswer: { '@type': 'Answer', text: f.answer },
    })),
  });
}

if (type === 'hub' && cityData) {
  schemaObjects.push({
    '@context': 'https://schema.org',
    '@type': 'TouristDestination',
    name: cityName,
    description: cityData.description,
    geo: { '@type': 'GeoCoordinates', latitude: cityData.lat, longitude: cityData.lng },
    containedInPlace: { '@type': 'Country', name: 'India' },
  });
}

const relatedLinks = (relatedPages ?? []).map(href => {
  const parts = href.replace(/^\/|\/$/g, '').split('/');
  const last = parts[parts.length - 1];
  const label = last.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
  return { href, label };
});

const categoryName = entry.data.category !== 'general'
  ? entry.data.category.split('-').map((w: string) => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')
  : title;
---

{type === 'hub' ? (
  <CityHub
    title={title}
    description={description}
    city={cityName}
    citySlug={citySlug}
    heroImage={cityHeroImage}
    bestMonths={bestMonths}
    goodMonths={goodMonths}
    faq={faq}
    relatedPages={relatedLinks}
    schema={schemaObjects}
  >
    <Content />
  </CityHub>
) : type === 'category' ? (
  <CategoryPage
    title={title}
    description={description}
    city={cityName}
    citySlug={citySlug}
    categoryName={categoryName}
    categorySlug={entry.data.category}
    heroImage={heroImage}
    faq={faq}
    relatedPages={relatedLinks}
    schema={schemaObjects}
  >
    <Content />
  </CategoryPage>
) : type === 'paa' ? (
  <PAAPage
    title={title}
    description={description}
    city={cityName}
    citySlug={citySlug}
    datePublished={datePublished}
    dateModified={dateModified}
    faq={faq}
    relatedPages={relatedLinks}
    schema={schemaObjects}
  >
    <Content />
  </PAAPage>
) : (
  <BaseLayout title={title} description={description} schema={schemaObjects}>
    <Content />
  </BaseLayout>
)}
